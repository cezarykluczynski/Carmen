machine:
  ruby:
    version:
      2.1.5
  java:
    version:
      oraclejdk8
  node:
    version:
      5.5.0
  services:
    - cassandra
dependencies:
  pre:
    - nvm install 0.12
    - nvm use 0.12
    - psql -c 'create database carmen;' -U postgres
    - cp src/main/resources/circleci/application.properties src/main/resources/application.properties
    - cp src/main/resources/travis/logback.xml src/main/resources/logback.xml
    - cp src/main/resources/travis/hibernate.cfg.xml src/main/resources/hibernate.cfg.xml
    - bundle install
    - git clone https://github.com/Contrast-Security-OSS/cassandra-migration.git cassandra-migration && rm -rf cassandra-migration/src/test/java && cd cassandra-migration && git reset --hard 9bfe574f76e5094c6bbde702c97e570d72962e25 && mvn clean install && cd ..
    - mvn compile
    - gem install sass
    - mvn flyway:migrate
    - sudo service cassandra restart
    - curl -sSL https://s3.amazonaws.com/circle-downloads/wait-for-cassandra.sh | sh
    - /usr/bin/nodetool enablethrift
    - /usr/bin/nodetool enablegossip
    - curl -sSL https://s3.amazonaws.com/circle-downloads/wait-for-cassandra.sh | sh
    - mvn exec:java -Dexec.mainClass="com.cezarykluczynski.carmen.db.CassandraMigrations"
    - sudo service cassandra restart
    - npm install --global grunt-cli typings tsd
    - cd src/main/webapp/frontend && npm install && cd ../../../..
    - mvn test -Dtest="BeforeAll"
test:
  override:
    - cd src/main/webapp/frontend && grunt to && cd ../../../..
    - mvn verify
    - rspec
  post:
    - bash <(curl -s https://codecov.io/bash) -f "src/main/webapp/frontend/coverage/coverage-final.json" -f "target/site/jacoco/ut/jacoco.xml" -f "target/site/jacoco/it/jacoco.xml" -f "target/site/simplecov/.resultset.json"
